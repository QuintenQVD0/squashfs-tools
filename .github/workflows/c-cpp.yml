name: Build squashfs-tools DEB packages

on:
  push:
    tags: ['v*']  # Trigger on version tags like v4.6.1
  workflow_dispatch:  # Allow manual triggering

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-22.04
            arch: amd64
          - os: ubuntu-22.04-arm
            arch: arm64
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential checkinstall liblz4-dev liblzo2-dev zlib1g-dev libzstd-dev liblzma-dev libz-dev

    - name: Build squashfs-tools
      run: |
        cd squashfs-tools
        make -j$(nproc)

    - name: Create DEB package with checkinstall
      run: |
        cd squashfs-tools
        sudo checkinstall -D --pkgname=squashfs-tools \
          --pkgversion=${GITHUB_REF#refs/tags/v} \
          --pkgrelease=1 \
          --pkglicense=GPL \
          --maintainer="github-actions@users.noreply.github.com" \
          --nodoc \
          --default \
          --install=no \
          --fstrans=yes \
          --arch=${{ matrix.arch }} \
          make install


    - name: Upload DEB artifact
      uses: actions/upload-artifact@v4
      with:
        name: squashfs-tools-${{ matrix.arch }}
        path: squashfs-tools/*.deb
        retention-days: 7
